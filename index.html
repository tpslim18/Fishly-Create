<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fish Forge ‚Äî Build & Swim</title>
  <style>
    :root{
      --bg1:#0b1f3a; --bg2:#072033; --panel:#0f2a4dA6; --panel-strong:#0f2a4d; --ink:#e8f4ff; --muted:#b7d5ff; --accent:#3fc4ff; --ok:#52ffa8; --warn:#ffd65b; --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--ink);
      background: radial-gradient(1200px 700px at 70% -10%, #1c6fb9 0%, transparent 60%),
                  radial-gradient(900px 600px at 20% 110%, #0d6a8a 0%, transparent 55%),
                  linear-gradient(180deg, var(--bg1), var(--bg2));
      min-height:100%;
      overflow:hidden;
    }
    header{
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 18px; gap:12px; position:relative; z-index:3;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,0));
      border-bottom: 1px solid rgba(255,255,255,.08);
      backdrop-filter: blur(8px);
    }
    header h1{margin:0;font-weight:800;letter-spacing:.3px;font-size:20px}
    .badge{font-size:12px; padding:4px 8px; border-radius:999px; background:#ffffff1a; border:1px solid #ffffff2a}

    main{display:grid; grid-template-columns: 340px 1fr; gap:18px; height:calc(100% - 62px); padding:18px;}

    /* PANEL */
    .panel{background:var(--panel); border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:14px; box-shadow:var(--shadow); backdrop-filter: blur(10px);}
    .panel h2{font-size:14px; letter-spacing:.2px; text-transform:uppercase; opacity:.9; margin:6px 0 10px}
    .controls{display:grid; gap:12px;}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
    .row3{display:grid; grid-template-columns:repeat(3, 1fr); gap:10px;}
    label{font-size:13px; opacity:.9; display:block; margin-bottom:6px}
    select,input[type="color"],button{width:100%;}
    select, input[type="color"]{
      background:#10345d; color:var(--ink); border:1px solid #1a4e86; border-radius:10px; padding:10px; outline:0;
      box-shadow: inset 0 0 0 1px #ffffff10;
    }
    input[type="range"]{width:100%}

    .btn{appearance:none; border:0; cursor:pointer; font-weight:700; padding:12px 14px; border-radius:12px; color:#072033; background:var(--ok); box-shadow:0 6px 0 #1e6b4d, 0 12px 24px rgba(0,0,0,.3); transform:translateY(0); transition: transform .12s ease, box-shadow .12s ease, filter .12s ease}
    .btn:hover{filter:brightness(1.05)}
    .btn:active{transform:translateY(2px); box-shadow:0 4px 0 #1e6b4d, 0 8px 18px rgba(0,0,0,.25)}
    .btn.secondary{background:var(--accent); box-shadow:0 6px 0 #235f78, 0 12px 24px rgba(0,0,0,.3)}
    .stack{display:flex; gap:10px;}

    /* PREVIEW / AQUARIUM */
    .stage{position:relative; border-radius:16px; overflow:hidden; height:100%;}
    .water{
      position:absolute; inset:0; overflow:hidden;
      background:
       radial-gradient(1000px 600px at 10% 10%, rgba(255,255,255,.06), transparent 40%),
       radial-gradient(1200px 800px at 80% 120%, rgba(255,255,255,.04), transparent 55%),
       linear-gradient(180deg, #0a2b49, #07253e 55%, #051e31);
    }
    .caustics{position:absolute; inset:0; opacity:.35; filter: blur(0.5px) contrast(120%);
      background: repeating-conic-gradient(from 0deg, rgba(255,255,255,.08) 0 6deg, transparent 6deg 12deg);
      mix-blend-mode: overlay; animation: drift 18s linear infinite;
    }
    @keyframes drift{from{transform: translateY(-15%) rotate(0)} to{transform: translateY(15%) rotate(360deg)}}

    .previewWrap{position:absolute; inset:0; display:grid; place-items:center}
    .previewCard{background:#0b2d52cc; border:1px solid #ffffff1f; border-radius:14px; padding:8px 10px}

    .speciesCard{position:absolute; inset:0; display:flex; align-items:center; justify-content:center; backdrop-filter: blur(6px);}
    .speciesInner{width:min(860px, 92%); background:#072742ee; border:1px solid #ffffff22; border-radius:18px; box-shadow:var(--shadow); display:grid; grid-template-columns: 1.2fr 1fr; gap:16px; padding:18px}
    .speciesInner h3{margin:0 0 6px 0; font-size:20px}
    .speciesInner p{margin:.4em 0; line-height:1.45}

    /* Aquarium */
    .aquarium{position:absolute; inset:0; overflow:hidden}
    .fishNode{position:absolute; left:0; top:50%; transform: translateY(-50%); will-change: transform;}
    .bubble{position:absolute; bottom:-40px; width:8px; height:8px; border-radius:50%; background: #bff3ff; opacity:.9; filter: blur(.2px);}
    @keyframes rise{from{transform:translateY(0) scale(1); opacity:.9} to{transform:translateY(-120vh) scale(1.2); opacity:.0}}

    .footerBar{position:absolute; right:18px; bottom:18px; display:flex; gap:10px; z-index:3}

    /* Utility */
    .hidden{display:none !important}
    .muted{color:var(--muted)}
    .tiny{font-size:12px; opacity:.9}
  </style>
</head>
<body>
  <header>
    <h1>üêü Fish Forge <span class="badge">Build ‚Ä¢ Name ‚Ä¢ Swim</span></h1>
    <div class="tiny muted">Tip: hit <b>Randomize</b> for inspiration.</div>
  </header>

  <main>
    <!-- LEFT: Controls -->
    <section class="panel" id="panel-controls">
      <h2>Customize your fish</h2>
      <div class="controls">
        <div>
          <label for="body">Body shape</label>
          <select id="body">
            <option value="torpedo">Torpedo</option>
            <option value="sunfish">Deep-bodied (Sunfish)</option>
            <option value="disk">Disk</option>
            <option value="eel">Eel-like</option>
            <option value="chunky">Chunky</option>
            <option value="dart">Dart</option>
          </select>
        </div>
        <div class="row">
          <div>
            <label for="eye">Eyes</label>
            <select id="eye">
              <option value="round">Round</option>
              <option value="cat">Cat-slit</option>
              <option value="googly">Googly</option>
              <option value="predator">Predator</option>
              <option value="tiny">Tiny</option>
              <option value="big">Big</option>
            </select>
          </div>
          <div>
            <label for="teeth">Teeth / Mouth</label>
            <select id="teeth">
              <option value="none">Toothless</option>
              <option value="nibblers">Nibblers</option>
              <option value="fangs">Fangs</option>
              <option value="beak">Beak</option>
              <option value="grinders">Grinders</option>
            </select>
          </div>
        </div>

        <div>
          <label for="markings">Markings</label>
          <select id="markings">
            <option value="none">None</option>
            <option value="stripes">Stripes</option>
            <option value="spots">Spots</option>
            <option value="saddle">Saddles</option>
            <option value="marbled">Marbled</option>
            <option value="lateral">Lateral Stripe</option>
            <option value="blotches">Blotches</option>
          </select>
        </div>

        <div class="row3">
          <div>
            <label for="base">Base</label>
            <input type="color" id="base" value="#2bb3ff" />
          </div>
          <div>
            <label for="accent">Accent</label>
            <input type="color" id="accent" value="#ff9f2b" />
          </div>
          <div>
            <label for="belly">Belly</label>
            <input type="color" id="belly" value="#e6fff8" />
          </div>
        </div>

        <div class="row">
          <div>
            <label for="size">Size</label>
            <select id="size">
              <option value="0.8">Small</option>
              <option value="1" selected>Medium</option>
              <option value="1.3">Large</option>
              <option value="1.6">XL</option>
            </select>
          </div>
          <div>
            <label for="fins">Tail style</label>
            <select id="tail">
              <option value="rounded">Rounded</option>
              <option value="forked">Forked</option>
              <option value="lunate">Lunate</option>
              <option value="spade">Spade</option>
            </select>
          </div>
        </div>

        <div class="stack">
          <button class="btn secondary" id="randomize">üé≤ Randomize</button>
          <button class="btn" id="build">üí° Build Species</button>
        </div>
      </div>
    </section>

    <!-- RIGHT: Stage -->
    <section class="panel stage" id="stage">
      <div class="water"></div>
      <div class="caustics"></div>
      <div class="previewWrap" id="previewWrap">
        <div class="previewCard">
          <svg id="fishPreview" width="420" height="260" viewBox="0 0 420 260" xmlns="http://www.w3.org/2000/svg"></svg>
        </div>
      </div>

      <!-- Species overlay (shown after Build) -->
      <div id="speciesCard" class="speciesCard hidden">
        <div class="speciesInner">
          <div>
            <svg id="fishSnapshot" width="100%" viewBox="0 0 420 260" xmlns="http://www.w3.org/2000/svg" style="background:#0a2b49; border-radius:14px; border:1px solid #ffffff1f"></svg>
          </div>
          <div>
            <h3 id="spName">Genus species</h3>
            <p class="muted" id="spTag"></p>
            <p id="spDesc"></p>
            <div class="stack" style="margin-top:10px">
              <button class="btn" id="confirm">‚úÖ Confirm</button>
              <button class="btn secondary" id="goBack">‚Ü©Ô∏è Tweak</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Aquarium runtime -->
      <div id="aquarium" class="aquarium hidden"></div>
      <div class="footerBar hidden" id="aquariumControls">
        <button class="btn secondary" id="reset">üîÅ Reset</button>
      </div>
    </section>
  </main>

  <script>
    // ---------- Utilities ----------
    const $ = sel => document.querySelector(sel);
    function hslToHex(h,s,l){ s/=100; l/=100; const k=n=> (n + h/30) % 12; const a = s*Math.min(l,1-l); const f = n => l - a*Math.max(-1, Math.min(k(n)-3, Math.min(9-k(n),1))); return '#'+[f(0),f(8),f(4)].map(x=> Math.round(255*x).toString(16).padStart(2,'0')).join('') }
    function hashStr(str){ let h=2166136261>>>0; for(let i=0;i<str.length;i++){h^=str.charCodeAt(i); h=(h*16777619)>>>0;} return h>>>0 }
    function mulberry32(a){ return function(){ let t=a+=0x6D2B79F5; t=Math.imul(t ^ t>>>15, t | 1); t ^= t + Math.imul(t ^ t>>>7, t | 61); return ((t ^ t>>>14) >>> 0) / 4294967296; } }

    function el(tag, attrs={}, children=[]) {
      const n = document.createElementNS('http://www.w3.org/2000/svg', tag);
      for(const k in attrs){ n.setAttribute(k, attrs[k]); }
      children.forEach(c=> n.appendChild(c));
      return n;
    }

    // ---------- Fish Renderer ----------
    const VIEW_W = 420, VIEW_H = 260, CX = 200, CY = 130;

    function renderFish(svg, opts, seedStr){
      svg.innerHTML = '';
      const seed = seedStr ?? JSON.stringify(opts);
      const rnd = mulberry32(hashStr(seed));

      const defs = el('defs');
      svg.appendChild(defs);

      // Gradients
      const gradId = 'g'+Math.floor(rnd()*1e9);
      const grad = el('linearGradient', {id:gradId, x1:'0%', y1:'0%', x2:'0%', y2:'100%'});
      grad.appendChild(el('stop',{offset:'0%','stop-color':opts.base}));
      grad.appendChild(el('stop',{offset:'70%','stop-color':opts.base}));
      grad.appendChild(el('stop',{offset:'100%','stop-color':opts.belly}));
      defs.appendChild(grad);

      // Accent gradient for fins/tail
      const accId = 'a'+Math.floor(rnd()*1e9);
      const acc = el('linearGradient', {id:accId, x1:'0%', y1:'0%', x2:'100%', y2:'0%'});
      acc.appendChild(el('stop',{offset:'0%','stop-color':opts.accent}));
      acc.appendChild(el('stop',{offset:'100%','stop-color':opts.base}));
      defs.appendChild(acc);

      // Body metrics by type
      const bodyMeta = {
        torpedo:{ rx:120, ry:58, snout:22 },
        sunfish:{ rx:95, ry:82, snout:16 },
        disk:{ rx:85, ry:85, snout:10 },
        eel:{ rx:155, ry:40, snout:14 },
        chunky:{ rx:110, ry:72, snout:18 },
        dart:{ rx:105, ry:55, snout:26 },
      };
      const meta = bodyMeta[opts.body] || bodyMeta.torpedo;

      // Main body (ellipse + subtle head bump)
      const body = el('ellipse', {cx:CX, cy:CY, rx:meta.rx, ry:meta.ry, fill:`url(#${gradId})`, stroke:'#00000025', 'stroke-width':2});
      svg.appendChild(body);

      // Nose / snout mask (visual hint of head)
      const head = el('path', {d:`M ${CX-meta.rx} ${CY} C ${CX-meta.rx+meta.snout} ${CY-meta.ry*.6}, ${CX-meta.rx+meta.snout} ${CY+meta.ry*.6}, ${CX-meta.rx} ${CY} Z`, fill:'#ffffff15'});
      svg.appendChild(head);

      // Fins
      const dorsal = el('path', {d:`M ${CX-30} ${CY-meta.ry+6} C ${CX+10} ${CY-meta.ry-16}, ${CX+40} ${CY-meta.ry+6}, ${CX+70} ${CY-2} L ${CX+10} ${CY-6} Z`, fill:`url(#${accId})`, opacity:.8});
      const anal = el('path', {d:`M ${CX-10} ${CY+meta.ry-4} C ${CX+30} ${CY+meta.ry+10}, ${CX+50} ${CY+meta.ry-2}, ${CX+70} ${CY+10} L ${CX+5} ${CY+6} Z`, fill:`url(#${accId})`, opacity:.85});
      svg.appendChild(dorsal); svg.appendChild(anal);

      // Tail geometry per style
      const tailX = CX + meta.rx - 10;
      const tailStyles = {
        rounded: () => `M ${tailX} ${CY-30} Q ${tailX+32} ${CY} ${tailX} ${CY+30} Q ${tailX-6} ${CY} ${tailX} ${CY-30} Z`,
        forked:  () => `M ${tailX} ${CY-34} L ${tailX+42} ${CY-2} L ${tailX} ${CY+34} Q ${tailX-8} ${CY} ${tailX} ${CY-34} Z`,
        lunate:  () => `M ${tailX} ${CY-36} Q ${tailX+56} ${CY} ${tailX} ${CY+36} Q ${tailX-10} ${CY} ${tailX} ${CY-36} Z`,
        spade:   () => `M ${tailX} ${CY-34} Q ${tailX+26} ${CY-10} ${tailX+40} ${CY} Q ${tailX+26} ${CY+10} ${tailX} ${CY+34} Q ${tailX-6} ${CY} ${tailX} ${CY-34} Z`,
      }
      const tail = el('path', {d: tailStyles[opts.tail](), fill:`url(#${accId})`, stroke:'#00000025','stroke-width':2});
      svg.appendChild(tail);

      // Pectoral fin
      const pec = el('path', {d:`M ${CX-25} ${CY+6} Q ${CX-4} ${CY+16} ${CX+10} ${CY+6} Q ${CX-4} ${CY-2} ${CX-25} ${CY+6} Z`, fill:opts.accent, opacity:.7});
      svg.appendChild(pec);

      // Eye styles
      const eyeX = CX - meta.rx + meta.snout + 22;
      const eyeY = CY - 8;
      const eye = el('circle', {cx:eyeX, cy:eyeY, r: opts.eye==='big'? 10 : opts.eye==='tiny'? 4 : 7, fill:'#fff'});
      svg.appendChild(eye);
      const pupilBaseR = (opts.eye==='big'? 5 : opts.eye==='tiny'? 2.2 : 3.3);
      if(opts.eye==='cat'){
        svg.appendChild(el('rect', {x:eyeX-(pupilBaseR/2), y:eyeY- (pupilBaseR*1.6), width:pupilBaseR, height:pupilBaseR*3.2, rx:1.6, fill:'#151515'}));
      }else if(opts.eye==='googly'){
        svg.appendChild(el('circle', {cx:eyeX + (rnd()*3-1.5), cy:eyeY + (rnd()*3-1.5), r:pupilBaseR, fill:'#151515'}));
      }else if(opts.eye==='predator'){
        svg.appendChild(el('circle', {cx:eyeX-1.4, cy:eyeY+0.4, r:pupilBaseR*1.1, fill:'#111'}));
        svg.appendChild(el('path', {d:`M ${eyeX-12} ${eyeY-9} q 8 -6 18 -2`, stroke:'#0000006a', 'stroke-width':3, fill:'none', 'stroke-linecap':'round'}));
      }else{
        svg.appendChild(el('circle', {cx:eyeX, cy:eyeY, r:pupilBaseR, fill:'#151515'}));
      }

      // Mouth & Teeth
      const mx = CX - meta.rx + meta.snout - 4, my = CY + 8;
      svg.appendChild(el('path', {d:`M ${mx} ${my} q 10 6 22 0`, stroke:'#00000066', 'stroke-width':3, fill:'none', 'stroke-linecap':'round'}));
      if(opts.teeth==='fangs'){
        svg.appendChild(el('path', {d:`M ${mx+8} ${my+1} l 0 10 l 6 -2 Z`, fill:'#f9f9f9'}));
        svg.appendChild(el('path', {d:`M ${mx+16} ${my} l 0 9 l 6 -2 Z`, fill:'#f9f9f9'}));
      } else if(opts.teeth==='beak'){
        svg.appendChild(el('path', {d:`M ${mx+6} ${my-1} q 6 3 10 0 q -6 5 -12 4 Z`, fill:'#d6c7a8'}));
      } else if(opts.teeth==='grinders'){
        for(let i=0;i<5;i++) svg.appendChild(el('rect', {x:mx+6+i*3.6, y:my+1.6, width:2.2, height:2.2, fill:'#f2f2f2', rx:.8}));
      } else if(opts.teeth==='nibblers'){
        for(let i=0;i<3;i++) svg.appendChild(el('path', {d:`M ${mx+6+i*6.2} ${my-1} q 3 3 0 6 q -3 -3 0 -6 Z`, fill:'#f9f9f9'}));
      }

      // Lateral line hint
      svg.appendChild(el('path', {d:`M ${CX-meta.rx+30} ${CY+6} q ${meta.rx*1.7} -6 ${meta.rx*1.7} 0`, stroke:'#ffffff28', 'stroke-width':2, fill:'none'}));

      // Markings
      const markGroup = el('g',{opacity:.65});
      const markColor = shade(opts.accent, -10);
      if(opts.markings==='stripes'){
        const count = 6 + Math.floor(rnd()*4);
        for(let i=0;i<count;i++){
          const x = CX - meta.rx + 40 + i*(meta.rx*1.2/count);
          const w = 8 + rnd()*8; const tilt = -18 + rnd()*12;
          markGroup.appendChild(el('rect', {x, y:CY-meta.ry+14, width:w, height:meta.ry*1.7, transform:`rotate(${tilt} ${x} ${CY})`, fill:markColor, rx:4}))
        }
      } else if(opts.markings==='spots'){
        const n = 18 + Math.floor(rnd()*14);
        for(let i=0;i<n;i++){
          const ang = rnd()*Math.PI*2, rr = meta.ry*0.7*rnd();
          const x = CX + Math.cos(ang)* (meta.rx-20) * (0.35 + rnd()*0.6);
          const y = CY + Math.sin(ang)* rr;
          const r = 4 + rnd()*6;
          markGroup.appendChild(el('circle', {cx:x, cy:y, r, fill:markColor}))
        }
      } else if(opts.markings==='saddle'){
        for(let i=0;i<5;i++){
          const x = CX - meta.rx + 40 + i*(meta.rx*1.6/4);
          markGroup.appendChild(el('rect', {x, y:CY-meta.ry+4, width:14+ rnd()*10, height:18+ rnd()*10, fill:markColor, rx:5}))
        }
      } else if(opts.markings==='marbled'){
        const p = el('path', {fill:markColor, opacity:.45});
        let d=`M ${CX-meta.rx+30} ${CY}`;
        for(let i=0;i<10;i++){
          const px = CX - meta.rx + 30 + i*(meta.rx*1.6/9);
          const py = CY + (rnd()*meta.ry*0.8 - meta.ry*0.4);
          d += ` Q ${px} ${py}, ${px+ (meta.rx*1.6/9)/2} ${CY + (rnd()*16-8)}`;
        }
        d += ` L ${CX+meta.rx-10} ${CY+meta.ry-6} L ${CX-meta.rx+30} ${CY+meta.ry-6} Z`;
        p.setAttribute('d', d);
        markGroup.appendChild(p);
      } else if(opts.markings==='lateral'){
        markGroup.appendChild(el('path', {d:`M ${CX-meta.rx+25} ${CY+8} q ${meta.rx*1.7} -4 ${meta.rx*1.7} 0`, stroke:markColor, 'stroke-width':6, fill:'none', 'stroke-linecap':'round'}));
      } else if(opts.markings==='blotches'){
        const n = 8 + Math.floor(rnd()*5);
        for(let i=0;i<n;i++){
          const x = CX - meta.rx + 40 + rnd()* (meta.rx*1.6);
          const y = CY - meta.ry*0.6 + rnd()* (meta.ry*1.2);
          const w = 16 + rnd()*26; const h = 10 + rnd()*18;
          markGroup.appendChild(el('ellipse', {cx:x, cy:y, rx:w/2, ry:h/2, fill:markColor}))
        }
      }
      svg.appendChild(markGroup);

      // Gloss highlight
      svg.appendChild(el('ellipse', {cx:CX-20, cy:CY-meta.ry*.6, rx:meta.rx*.6, ry:meta.ry*.25, fill:'#ffffff22'}));

      // Outline soft
      svg.appendChild(el('ellipse', {cx:CX, cy:CY, rx:meta.rx, ry:meta.ry, fill:'none', stroke:'#00000028', 'stroke-width':2}));

      function shade(hex, amt){
        let [r,g,b] = hex.replace('#','').match(/.{2}/g).map(x=>parseInt(x,16));
        r=Math.max(0,Math.min(255,r+amt)); g=Math.max(0,Math.min(255,g+amt)); b=Math.max(0,Math.min(255,b+amt));
        return '#'+[r,g,b].map(x=>x.toString(16).padStart(2,'0')).join('');
      }
    }

    // ---------- Species Name & Description ----------
    function generateSpecies(opts){
      const genusMap = {
        torpedo:['Veloc','Stri','Thunna','Aer'],
        sunfish:['Platy','Aur','Pachy','Gibb'],
        disk:['Cyclo','Disco','Orbi','Pufi'],
        eel:['Serpento','Anguill','Ribbon','Sinu'],
        chunky:['Bary','Robus','Macro','Bulbi'],
        dart:['Acuto','Sagitt','Darto','Xiphi']
      }[opts.body];
      const eyeAffix = {
        round:'-ops', cat:'-ocel', googly:'-glo', predator:'-raptor', tiny:'-microps', big:'-macro-ops'
      }[opts.eye] || '-ops';
      const teethSuffix = {
        none:'a', nibblers:'donta', fangs:'fangi', beak:'rostra', grinders:'molara'
      }[opts.teeth] || 'a';
      const markEpithet = {
        none:'plainis', stripes:'striatus', spots:'maculatus', saddle:'saddlensis', marbled:'marmoreus', lateral:'lineatus', blotches:'blotchii'
      }[opts.markings];

      // Color-based epithet
      function hexToH(hex){
        const h=parseInt(hex.slice(1),16); const r=(h>>16)&255,g=(h>>8)&255,b=h&255;
        const mx=Math.max(r,g,b), mn=Math.min(r,g,b), d=mx-mn; let hue=0;
        if(d===0) hue=0; else if(mx===r) hue=((g-b)/d)%6; else if(mx===g) hue=(b-r)/d+2; else hue=(r-g)/d+4;
        hue=Math.round(hue*60); if(hue<0) hue+=360; return hue;
      }
      const hue = hexToH(opts.base);
      const colorEpithet = hue<30? 'rubra' : hue<70? 'aurantius' : hue<140? 'viridis' : hue<210? 'caeruleus' : hue<270? 'indicus' : 'violaceus';

      const genus = (genusMap[Math.floor(Math.random()*genusMap.length)] + eyeAffix).replace('--','-');
      const species = `${markEpithet}-${teethSuffix}`.replace('--','-');
      const binomial = `${capitalize(genus)} ${species}`;

      // Description, tailored to parts
      const bodyText = {
        torpedo:'streamlined and built for speed',
        sunfish:'tall-bodied with excellent maneuverability',
        disk:'pancake-round and surprisingly agile',
        eel:'long and ribbon-like for slinking through weeds',
        chunky:'thick-set and powerful in short bursts',
        dart:'arrow-shaped and twitchy-fast'
      }[opts.body];

      const diet = {
        none:'filtering tiny crustaceans',
        nibblers:'pecking algae and invertebrates',
        fangs:'ambushing minnows',
        beak:'cracking snails and mussels',
        grinders:'munching bottom-dwellers'
      }[opts.teeth];

      const eyeMood = {
        round:'curious gaze', cat:'nocturnal glare', googly:'goofy stare', predator:'focused stare', tiny:'beady look', big:'wide-eyed look'
      }[opts.eye];

      const markLook = {
        none:'plain-sheened', stripes:'banded', spots:'spotted', saddle:'saddle-marked', marbled:'marbled', lateral:'racing-striped', blotches:'blotched'
      }[opts.markings];

      const desc = `A ${markLook} fish with ${eyeMood}. Its ${bodyText} pairs with a ${humanColor(opts.base)} base and pale belly. Typically found cruising midwater, it prefers ${diet} and flashes ${humanColor(opts.accent)} fins when startled.`;

      return { binomial, epithet: `${markLook}, ${colorEpithet}`, desc };

      function capitalize(s){ return s.charAt(0).toUpperCase()+s.slice(1) }
      function humanColor(hex){
        const p=parseInt(hex.slice(1),16); const r=(p>>16)&255,g=(p>>8)&255,b=p&255; const max=Math.max(r,g,b), min=Math.min(r,g,b); const l=(max+min)/2/255;
        const h=hexToH(hex); const names=[{n:'red',h:0},{n:'orange',h:35},{n:'gold',h:55},{n:'green',h:120},{n:'aqua',h:170},{n:'blue',h:210},{n:'purple',h:270},{n:'magenta',h:310}];
        let nearest=names[0]; let dh=999; names.forEach(o=>{ const d=Math.abs(o.h-h); if(d<dh){dh=d; nearest=o}});
        const tone = l>0.7? 'light' : l<0.35? 'dark' : 'rich'; return `${tone} ${nearest.n}`;
      }
    }

    // ---------- State & DOM wiring ----------
    const inputs = { body:$('#body'), eye:$('#eye'), teeth:$('#teeth'), markings:$('#markings'), base:$('#base'), accent:$('#accent'), belly:$('#belly'), size:$('#size'), tail:$('#tail') };

    function getOpts(){
      return { body:inputs.body.value, eye:inputs.eye.value, teeth:inputs.teeth.value, markings:inputs.markings.value, base:inputs.base.value, accent:inputs.accent.value, belly:inputs.belly.value, size:parseFloat(inputs.size.value), tail:inputs.tail.value };
    }

    function updatePreview(){
      const opts = getOpts();
      renderFish($('#fishPreview'), opts);
    }

    ['change','input'].forEach(evt=> Object.values(inputs).forEach(el=> el.addEventListener(evt, updatePreview)));

    // Randomize
    $('#randomize').addEventListener('click', ()=>{
      const pick = (sel)=>{ const i=Math.floor(Math.random()*sel.options.length); sel.selectedIndex=i; };
      pick(inputs.body); pick(inputs.eye); pick(inputs.teeth); pick(inputs.markings); pick(inputs.size); pick(inputs.tail);
      const randHex = ()=> hslToHex(Math.floor(Math.random()*360), 70 + Math.random()*25, 45 + Math.random()*20);
      inputs.base.value = randHex();
      inputs.accent.value = hslToHex((Math.random()*360)|0, 80, 55);
      inputs.belly.value = hslToHex((Math.random()*360)|0, 20, 92);
      updatePreview();
    });

    // Build (Species card)
    $('#build').addEventListener('click', ()=>{
      const opts = getOpts();
      const prev = $('#fishPreview');
      renderFish(prev, opts); // ensure fresh

      // Snapshot into card
      const snap = $('#fishSnapshot');
      snap.innerHTML = prev.innerHTML; // clone drawing
      // Scale snapshot to chosen size visually via viewBox preserve
      const k = opts.size;
      snap.setAttribute('viewBox', `0 0 ${VIEW_W} ${VIEW_H}`);
      snap.style.transform = `scale(${Math.min(1.3,k)}) translateY(${(1-k)*15}px)`;
      snap.style.transformOrigin = '50% 60%';

      const sp = generateSpecies(opts);
      $('#spName').textContent = sp.binomial;
      $('#spTag').textContent = sp.epithet.replaceAll('-', ' ');
      $('#spDesc').textContent = sp.desc;

      $('#speciesCard').classList.remove('hidden');
    });

    $('#goBack').addEventListener('click', ()=> $('#speciesCard').classList.add('hidden'));

    // Confirm -> Aquarium
    let swimRAF=null, swimState=null, bubbleTimer=null;

    $('#confirm').addEventListener('click', ()=>{
      $('#speciesCard').classList.add('hidden');
      $('#panel-controls').classList.add('hidden');
      $('#aquarium').classList.remove('hidden');
      $('#aquariumControls').classList.remove('hidden');
      startAquarium(getOpts());
    });

    $('#reset').addEventListener('click', resetAll);

    function resetAll(){
      cancelAnim();
      $('#aquarium').innerHTML='';
      $('#aquarium').classList.add('hidden');
      $('#aquariumControls').classList.add('hidden');
      $('#panel-controls').classList.remove('hidden');
      updatePreview();
    }

    function cancelAnim(){
      if(swimRAF) cancelAnimationFrame(swimRAF); swimRAF=null;
      if(bubbleTimer) clearInterval(bubbleTimer); bubbleTimer=null;
      swimState=null;
    }

    function startAquarium(opts){
      cancelAnim();
      const aq = $('#aquarium');
      const fishNode = document.createElement('div');
      fishNode.className = 'fishNode';
      const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      svg.setAttribute('width', 420*opts.size);
      svg.setAttribute('height', 260*opts.size);
      svg.setAttribute('viewBox','0 0 420 260');
      renderFish(svg, opts, JSON.stringify(opts));
      fishNode.appendChild(svg);
      aq.appendChild(fishNode);

      // Start somewhere random
      const rect = aq.getBoundingClientRect();
      const fw = 420*opts.size, fh = 260*opts.size;
      let x = Math.random()*(rect.width - fw), y = rect.height*0.5 - fh*0.5;
      let dir = Math.random()<0.5? 1 : -1; // 1 => right
      let speed = 30 + Math.random()*30; // px/s
      const bobAmp = 10 + Math.random()*12; let t=0;

      function step(ts){
        if(!swimState){ swimState={last: ts}; }
        const dt = (ts - swimState.last)/1000; swimState.last = ts; t+=dt;
        x += dir * speed * dt;
        const bob = Math.sin(t*2)*bobAmp;
        if(x < 0){ dir=1; } else if(x > rect.width - fw){ dir=-1; }
        fishNode.style.transform = `translate(${x}px, ${y + bob}px) scaleX(${dir})`;
        swimRAF = requestAnimationFrame(step);
      }
      swimRAF = requestAnimationFrame(step);

      // Bubbles
      bubbleTimer = setInterval(()=>{
        const b = document.createElement('div'); b.className='bubble';
        const size = 4 + Math.random()*10; b.style.width=b.style.height=size+'px';
        b.style.left = (Math.random()*rect.width)+'px';
        b.style.animation = `rise ${8+Math.random()*6}s linear forwards`;
        aq.appendChild(b); setTimeout(()=> b.remove(), 16000);
      }, 600);

      // Resize handling
      addEventListener('resize', ()=>{ /* re-read bounds on next tick */ });
    }

    // Initial
    updatePreview();
  </script>
</body>
</html>
