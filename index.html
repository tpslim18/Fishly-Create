<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fish Forge ‚Äî One‚ÄëFile Build</title>
  <style>
    :root{--ink:#0b1f2a;--ui:#0e2848;--muted:#b7d5ff;--panel:#0e2848d9;--bg1:#0a1d34;--bg2:#061424;}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial;color:#e8f4ff;background:linear-gradient(180deg,var(--bg1),var(--bg2));}
    h1{margin:8px 0 6px;text-align:center}
    #ui{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;padding:10px;background:#0a1e33;border-bottom:1px solid #ffffff1a}
    #ui label{font-size:12px;opacity:.9;display:flex;align-items:center;gap:6px;background:#0d2a48;padding:8px 10px;border-radius:10px;border:1px solid #ffffff1a}
    #ui select,#ui input[type=color],#ui input[type=text]{padding:8px 10px;border-radius:8px;border:1px solid #1a4e86;background:#10345d;color:#e8f4ff}
    #ui button{appearance:none;border:0;border-radius:10px;padding:10px 12px;font-weight:700;cursor:pointer}
    .primary{background:#30e2a1;color:#052420;box-shadow:0 4px 0 #1b8c67}
    .secondary{background:#36c3ff;color:#05243a;box-shadow:0 4px 0 #1b6b8c}
    #tank{position:relative;width:min(1000px,94vw);aspect-ratio:16/9;margin:14px auto;border-radius:14px;overflow:hidden;box-shadow:0 18px 60px #0006;border:1px solid #ffffff1a}
    canvas{display:block;width:100%;height:100%}
    .modal{position:fixed;inset:0;background:#0008;display:flex;align-items:center;justify-content:center}
    .modal.hidden{display:none}
    .card{background:#072742;border:1px solid #ffffff22;border-radius:14px;box-shadow:0 20px 60px #0006;display:flex;gap:16px;padding:16px;max-width:min(900px,92vw)}
    .card h3{margin:.2em 0 .3em}
  </style>
</head>
<body>
  <h1>üêü Fish Forge</h1>
  <div id="ui">
    <label>Body <select id="body">
      <option value="torpedo">Torpedo</option>
      <option value="disk">Disk</option>
      <option value="sunfish">Sunfish</option>
      <option value="eel">Eel</option>
      <option value="chunky">Chunky</option>
      <option value="dart">Dart</option>
    </select></label>
    <label>Eyes <select id="eyes">
      <option value="round">Round</option>
      <option value="predator">Predator</option>
      <option value="big">Big</option>
      <option value="tiny">Tiny</option>
      <option value="cat">Cat</option>
      <option value="googly">Googly</option>
    </select></label>
    <label>Teeth <select id="teeth">
      <option value="none">None</option>
      <option value="nibblers">Nibblers</option>
      <option value="fangs">Fangs</option>
      <option value="beak">Beak</option>
      <option value="grinders">Grinders</option>
    </select></label>
    <label>Pattern <select id="pattern">
      <option value="none">None</option>
      <option value="stripes">Stripes</option>
      <option value="spots">Spots</option>
      <option value="gradient">Gradient</option>
      <option value="lateral">Lateral line</option>
    </select></label>
    <label>Tail <select id="tail">
      <option value="rounded">Rounded</option>
      <option value="forked">Forked</option>
      <option value="lunate">Lunate</option>
      <option value="spade">Spade</option>
    </select></label>
    <label>Body <input type="color" id="colBody" value="#2bb3ff"></label>
    <label>Accent <input type="color" id="colAccent" value="#ffa233"></label>
    <label>Name <input id="fishNameInput" type="text" placeholder="e.g., Bubbles" maxlength="20"></label>
    <label style="gap:6px"><input type="checkbox" id="showNameTag" checked>Show tag</label>
    <button id="build" class="primary">Build Species</button>
    <button id="saveFishBtn" class="secondary">Save PNG (Fish)</button>
    <button id="saveSceneBtn" class="secondary">Save PNG (Scene)</button>
    <label style="gap:6px"><input type="checkbox" id="transparentBg" checked>Transparent fish PNG</label>
  </div>

  <div id="tank">
    <canvas id="canvas"></canvas>
  </div>

  <div id="speciesModal" class="modal hidden">
    <div class="card">
      <canvas id="previewCanvas" width="420" height="260" style="background:#0a2b49;border-radius:10px;border:1px solid #ffffff22"></canvas>
      <div>
        <h3 id="speciesName">Genus species</h3>
        <p id="speciesDesc">A newly discovered species with characteristics based on your design.</p>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
          <button id="downloadPreview" class="secondary">Download PNG</button>
          <button id="closeModal" class="primary">Looks good</button>
        </div>
      </div>
    </div>
  </div>

<script>
// ---------- Canvas & Tank ----------
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
function fit(){ const rect=document.getElementById('tank').getBoundingClientRect(); canvas.width=rect.width; canvas.height=rect.height; }
fit(); addEventListener('resize', fit);

// ---------- UI ----------
const $ = s=>document.querySelector(s);
const inputs = { body:$('#body'), eyes:$('#eyes'), teeth:$('#teeth'), pattern:$('#pattern'), tail:$('#tail'), colBody:$('#colBody'), colAccent:$('#colAccent'), name:$('#fishNameInput'), showTag:$('#showNameTag') };

// ---------- Fish Model ----------
const metrics = { torpedo:{w:70,h:30,snout:20}, disk:{w:48,h:48,snout:12}, sunfish:{w:55,h:60,snout:14}, eel:{w:95,h:18,snout:14}, chunky:{w:78,h:38,snout:16}, dart:{w:60,h:26,snout:20} };
let fish = null;

function mkFish(){
  const f = {
    x: canvas.width*0.5, y: canvas.height*0.6, vx: 90, vy: 28, dir: 1,
    body: inputs.body.value, eyes: inputs.eyes.value, teeth: inputs.teeth.value,
    pattern: inputs.pattern.value, tail: inputs.tail.value,
    color: inputs.colBody.value, accent: inputs.colAccent.value,
    name: (inputs.name.value||'Bubbles').slice(0,20), showTag: inputs.showTag.checked,
    size: 1, phase: 0
  };
  return f;
}

// ---------- Helpers ----------
function rnd(min,max){return min+Math.random()*(max-min)}
function setAlpha(c,a){const r=parseInt(c.slice(1,3),16),g=parseInt(c.slice(3,5),16),b=parseInt(c.slice(5,7),16);return `rgba(${r},${g},${b},${a})`}

// ---------- Render Pieces ----------
function drawBodyClipped(g, m, col, accent, phase, lateral){
  g.save();
  g.beginPath();
  g.ellipse(0,0,m.w,m.h,0,0,Math.PI*2);
  g.fillStyle = col; g.fill();
  g.save(); g.clip();
  // dorsal shading & belly lift
  const grad = g.createLinearGradient(0,-m.h,0,m.h);
  grad.addColorStop(0, setAlpha('#000000',0.20));
  grad.addColorStop(0.55, setAlpha('#000000',0.00));
  grad.addColorStop(1, setAlpha('#ffffff',0.06));
  g.fillStyle = grad; g.fillRect(-m.w-2,-m.h-2,(m.w+2)*2,(m.h+2)*2);
  // specular shimmer
  g.beginPath(); g.ellipse(-m.w*0.15 + Math.sin(phase)*4, -m.h*0.45, m.w*0.55, m.h*0.22, 0, 0, Math.PI*2);
  g.fillStyle = setAlpha('#ffffff',0.10); g.fill();
  if(lateral){ g.lineCap='round'; g.strokeStyle=setAlpha(accent,0.7); g.lineWidth=6; g.beginPath(); g.moveTo(-m.w*0.85, m.h*0.1); g.quadraticCurveTo(m.w*0.1, -m.h*0.05, m.w*0.9, 0); g.stroke(); }
  g.restore();
}
function drawMarkings(g, m, pattern, accent, phase){
  g.save(); g.beginPath(); g.ellipse(0,0,m.w,m.h,0,0,Math.PI*2); g.clip();
  if(pattern==='stripes'){
    for(let x=-m.w*0.9; x<m.w*0.9; x+=10){
      const angle = -0.35 + Math.sin((x+m.w+phase*20)/30)*0.12;
      g.save(); g.translate(x,0); g.rotate(angle); g.fillStyle=setAlpha('#000000',0.25); g.fillRect(-3,-m.h*1.1,6,m.h*2.2); g.restore();
    }
  } else if(pattern==='spots'){
    const n=18; g.fillStyle=setAlpha('#000000',0.24);
    for(let i=0;i<n;i++){ const rx=rnd(-m.w*0.6,m.w*0.7), ry=rnd(-m.h*0.6,m.h*0.6), r=rnd(3,7); g.beginPath(); g.arc(rx, ry, r, 0, Math.PI*2); g.fill(); }
  } else if(pattern==='gradient'){
    const lg = g.createLinearGradient(-m.w,0,m.w,0); lg.addColorStop(0, setAlpha('#ffffff',0.12)); lg.addColorStop(0.5, setAlpha('#000000',0.00)); lg.addColorStop(1, setAlpha('#000000',0.15)); g.fillStyle = lg; g.fillRect(-m.w,-m.h,m.w*2,m.h*2);
  }
  g.restore();
}
function drawTail(g, m, tail, accent, phase){
  const swing = Math.sin(phase*8)* (m.bodyType==='eel'? 22:14) * Math.PI/180;
  g.save(); g.translate(-m.w*0.98, 0); g.rotate(swing);
  g.beginPath();
  if(tail==='forked'){ g.moveTo(0,0); g.lineTo(-m.w*0.55,-m.h*0.55); g.lineTo(-m.w*0.15,0); g.lineTo(-m.w*0.55,m.h*0.55); g.closePath(); }
  else if(tail==='lunate'){ g.moveTo(0,-m.h*0.6); g.quadraticCurveTo(-m.w*0.9,0,0,m.h*0.6); g.quadraticCurveTo(-m.w*0.2,0,0,-m.h*0.6); g.closePath(); }
  else if(tail==='spade'){ g.moveTo(0,-m.h*0.5); g.quadraticCurveTo(-m.w*0.35,-m.h*0.15,-m.w*0.6,0); g.quadraticCurveTo(-m.w*0.35,m.h*0.15,0,m.h*0.5); g.lineTo(-m.w*0.1,0); g.closePath(); }
  else { g.moveTo(0,-m.h*0.5); g.quadraticCurveTo(-m.w*0.55,0,0,m.h*0.5); g.quadraticCurveTo(-m.w*0.12,0,0,-m.h*0.5); g.closePath(); }
  g.fillStyle=setAlpha(accent,0.9); g.fill(); g.restore();
}
function drawFins(g, m, accent, phase){
  g.save();
  // dorsal
  g.beginPath(); g.moveTo(-m.w*0.2,-m.h*0.9); g.quadraticCurveTo(m.w*0.25,-m.h*1.2, m.w*0.55,-m.h*0.2 + Math.sin(phase*6)*4); g.lineTo(m.w*0.05,-m.h*0.15); g.closePath(); g.fillStyle=setAlpha(accent,0.85); g.fill();
  // anal
  g.beginPath(); g.moveTo(-m.w*0.05,m.h*0.85); g.quadraticCurveTo(m.w*0.35,m.h*1.1, m.w*0.55,m.h*0.15 + Math.sin(phase*6+1.2)*3); g.lineTo(m.w*0.02,m.h*0.1); g.closePath(); g.fill();
  // pectoral flapping
  g.save(); g.translate(-m.w*0.3, m.h*0.05); g.rotate(Math.sin(phase*10)*0.25); g.beginPath(); g.ellipse(0,0,m.w*0.18,m.h*0.14,0,0,Math.PI*2); g.fillStyle=setAlpha(accent,0.75); g.fill(); g.restore();
  g.restore();
}
function drawEye(g,m,kind){
  const r = kind==='big'? 6.5 : kind==='tiny'? 3.5 : 5;
  g.save(); g.translate(m.w*0.35, -m.h*0.25);
  g.beginPath(); g.arc(0,0,r+2,0,Math.PI*2); g.fillStyle='#fff'; g.fill();
  if(kind==='cat'){ g.fillStyle='#111'; g.fillRect(-1.5,-r,3,r*2); }
  else if(kind==='googly'){ g.beginPath(); g.arc(rnd(-1,1),rnd(-1,1),r*0.6,0,Math.PI*2); g.fillStyle='#111'; g.fill(); }
  else if(kind==='predator'){ g.beginPath(); g.arc(-1.2,0.6,r*0.65,0,Math.PI*2); g.fillStyle='#111'; g.fill(); g.beginPath(); g.moveTo(-r-4,-r-2); g.quadraticCurveTo(0,-r-6,r+2,-r+2); g.strokeStyle='#0006'; g.lineWidth=2; g.stroke(); }
  else { g.beginPath(); g.arc(0,0,r*0.6,0,Math.PI*2); g.fillStyle='#111'; g.fill(); }
  g.restore();
}
function drawMouthTeeth(g,m,kind){
  const mx = m.w*0.9*-1 + m.snout*0.35, my = m.h*0.25;
  g.save(); g.translate(mx,my); g.rotate(0.02);
  g.beginPath(); g.moveTo(0,0); g.quadraticCurveTo(10,6,22,0); g.strokeStyle='#0006'; g.lineWidth=2.5; g.lineCap='round'; g.stroke();
  if(kind==='fangs'){ g.fillStyle='#f9f9f9'; g.beginPath(); g.moveTo(8,1); g.lineTo(8,11); g.lineTo(14,9); g.closePath(); g.fill(); g.beginPath(); g.moveTo(16,0); g.lineTo(16,10); g.lineTo(22,8); g.closePath(); g.fill(); }
  else if(kind==='beak'){ g.fillStyle='#d6c7a8'; g.beginPath(); g.moveTo(6,-1); g.quadraticCurveTo(12,3,16,0); g.quadraticCurveTo(10,6,4,5); g.closePath(); g.fill(); }
  else if(kind==='grinders'){ g.fillStyle='#f2f2f2'; for(let i=0;i<5;i++){ g.fillRect(6+i*3.6,2,2.2,2.2); } }
  else if(kind==='nibblers'){ g.fillStyle='#f9f9f9'; for(let i=0;i<3;i++){ g.beginPath(); g.moveTo(6+i*6.2,-1); g.quadraticCurveTo(9+i*6.2,2,6+i*6.2,5); g.quadraticCurveTo(3+i*6.2,2,6+i*6.2,-1); g.fill(); } }
  g.restore();
}

function drawNameTag(g, F){
  if(!F.showTag || !F.name) return;
  const m = metrics[F.body];
  const yOffset = -m.h*F.size - 22;
  const paddingX = 8, r = 10;
  g.save();
  const text = F.name; g.font='600 14px Inter, system-ui, sans-serif';
  const tw = Math.min(g.measureText(text).width, 220);
  const boxW = tw + paddingX*2, boxH = 24;
  let bx = F.x - boxW/2, by = F.y + yOffset;
  bx = Math.max(6, Math.min(bx, canvas.width - boxW - 6));
  by = Math.max(6, Math.min(by, canvas.height - boxH - 6));
  g.beginPath(); const x=bx,y=by,w=boxW,h=boxH; g.moveTo(x+r,y); g.arcTo(x+w,y,x+w,y+h,r); g.arcTo(x+w,y+h,x,y+h,r); g.arcTo(x,y+h,x,y,r); g.arcTo(x,y,x+w,y,r); g.closePath();
  g.fillStyle='rgba(7,39,66,0.8)'; g.fill(); g.strokeStyle='rgba(255,255,255,0.25)'; g.lineWidth=1; g.stroke();
  g.fillStyle='#e8f4ff'; g.textBaseline='middle'; g.fillText(text, bx + paddingX, by + h/2);
  g.restore();
}

function drawFish(g, F, dt){
  const m0 = metrics[F.body];
  const m = { ...m0, w:m0.w*F.size, h:m0.h*F.size, bodyType:F.body };
  const speed = Math.hypot(F.vx,F.vy);
  const heading = Math.atan2(F.vy, F.vx*F.dir);
  const phase = (F.phase += (0.8 + speed/140) * dt);

  g.save();
  g.translate(F.x, F.y);
  g.rotate(heading);
  g.transform(1, 0, Math.sin(phase*2)*0.03, 1, 0, 0); // subtle body yaw

  drawBodyClipped(g, m, F.color, F.accent, phase, F.pattern==='lateral');
  if(F.pattern!=='lateral') drawMarkings(g, m, F.pattern, F.accent, phase);
  drawTail(g, m, F.tail, F.accent, phase);
  drawFins(g, m, F.accent, phase);
  drawEye(g, m, F.eyes);
  drawMouthTeeth(g, m, F.teeth);
  g.restore();
}

// ---------- Sim loop ----------
let last=0; const bubbles=[];
function loop(ts){
  if(!last) last=ts; const dt=(ts-last)/1000; last=ts;
  // background
  const grad=ctx.createLinearGradient(0,0,0,canvas.height); grad.addColorStop(0,'#0a2b49'); grad.addColorStop(.6,'#072a44'); grad.addColorStop(1,'#062136'); ctx.fillStyle=grad; ctx.fillRect(0,0,canvas.width,canvas.height);

  // fish
  if(fish){
    fish.x += fish.vx*fish.dir*dt; fish.y += fish.vy*dt;
    if(fish.x < 60){ fish.dir=1; }
    if(fish.x > canvas.width-60){ fish.dir=-1; }
    if(fish.y < 40 || fish.y > canvas.height-40){ fish.vy *= -1; }

    // bubbles from tail
    if(Math.random()<0.12){ bubbles.push({x:fish.x- metrics[fish.body].w*0.9, y:fish.y + Math.sin(fish.phase*8)*6, r:rnd(2,5), vy:rnd(40,70), a:1}); }
    for(let i=bubbles.length-1;i>=0;i--){ const b=bubbles[i]; b.y -= b.vy*dt; b.a -= 0.4*dt; if(b.a<=0) bubbles.splice(i,1); ctx.beginPath(); ctx.arc(b.x, b.y, b.r, 0, Math.PI*2); ctx.fillStyle='rgba(191,243,255,'+Math.max(0,b.a)+')'; ctx.fill(); }

    drawFish(ctx, fish, dt);
    drawNameTag(ctx, fish);
  }
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

// ---------- Species modal ----------
const preview = document.getElementById('previewCanvas');
const pctx = preview.getContext('2d');
function openSpeciesCard(){
  const genusBits = {torpedo:'Veloc',disk:'Cyclo',sunfish:'Platy',eel:'Anguill',chunky:'Bary',dart:'Sagitt'}[fish.body];
  const epithet = {stripes:'striatus',spots:'maculatus',gradient:'nitidus',lateral:'lineatus',none:'clarus'}[fish.pattern];
  const binomial = `${genusBits}${Math.random()<.5?'-ops':''} ${epithet}`;
  $('#speciesName').textContent = binomial;
  $('#speciesDesc').textContent = `A ${fish.body} form with ${fish.pattern==='none'?'plain sheen':fish.pattern} patterning and ${fish.tail} tail. Nickname: ${fish.name}.`;
  pctx.clearRect(0,0,preview.width,preview.height);
  const temp = {...fish, x: preview.width*0.55, y: preview.height*0.62, vx: 0, vy: 0, phase: 0, size: .95};
  drawFish(pctx, temp, 0.016);
  drawNameTag(pctx, temp);
  $('#speciesModal').classList.remove('hidden');
}
$('#closeModal').onclick = ()=> $('#speciesModal').classList.add('hidden');

// ---------- Build button ----------
$('#build').onclick = ()=>{ fish = mkFish(); openSpeciesCard(); };

// ---------- PNG Export ----------
function downloadDataURL(dataURL, filename){ const a=document.createElement('a'); a.href=dataURL; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); }
function sanitizeName(s){ return (s||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,''); }
function renderFishToCanvas(w,h, opts){
  const c=document.createElement('canvas'); c.width=w; c.height=h; const g=c.getContext('2d');
  if(!opts.transparent){ const grad=g.createLinearGradient(0,0,0,h); grad.addColorStop(0,'#0a2b49'); grad.addColorStop(.6,'#072a44'); grad.addColorStop(1,'#062136'); g.fillStyle=grad; g.fillRect(0,0,w,h); }
  const temp={...fish, x:w*0.55, y:h*0.6, vx:0, vy:0, phase:0, size: Math.min(w/800, h/480)*1.3 };
  drawFish(g, temp, 0.016); drawNameTag(g, temp); return c;
}
function saveFishPNG(){ if(!fish) return; const transparent = $('#transparentBg').checked; const scale = 3; const baseW = 420, baseH = 260; const c = renderFishToCanvas(baseW*scale, baseH*scale, {transparent}); const speciesSafe = sanitizeName($('#speciesName').textContent || 'fish'); const petSafe = sanitizeName(fish.name || 'pet'); const name = `${petSafe}-${speciesSafe}${transparent?'-transparent':''}.png`; downloadDataURL(c.toDataURL('image/png'), name); }
function saveScenePNG(){ if(!fish) return; const c=document.createElement('canvas'); c.width=canvas.width; c.height=canvas.height; const g=c.getContext('2d'); g.drawImage(canvas,0,0); const petSafe = sanitizeName(fish.name || 'fish'); downloadDataURL(c.toDataURL('image/png'), `${petSafe}-scene.png`); }
$('#saveFishBtn').onclick = saveFishPNG; $('#saveSceneBtn').onclick = saveScenePNG; $('#downloadPreview').onclick = saveFishPNG;
</script>
</body>
</html>
